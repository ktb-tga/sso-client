import{useState as t,useRef as e,useCallback as r,useEffect as i}from"react";function n(){return n=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(t[i]=r[i])}return t},n.apply(this,arguments)}var o=0;function a(t){return"__private_"+o+++"_"+t}function s(t,e){if(!Object.prototype.hasOwnProperty.call(t,e))throw new TypeError("attempted to use private field on non-instance");return t}var l=/*#__PURE__*/a("apiURL"),c=/*#__PURE__*/a("appURL"),u=/*#__PURE__*/a("authenticateEndpoint"),h=/*#__PURE__*/a("userInfoEndpoint"),p=/*#__PURE__*/a("mode"),d=/*#__PURE__*/a("ssoURL"),g=/*#__PURE__*/a("preflightURL"),y=/*#__PURE__*/a("redirectPath"),f=/*#__PURE__*/a("localStorageKey"),w=/*#__PURE__*/a("bearerTokenKey"),S=/*#__PURE__*/a("originSourceQuery");const b=new class{constructor({apiURL:t}={}){Object.defineProperty(this,l,{writable:!0,value:void 0}),Object.defineProperty(this,c,{writable:!0,value:window.location.origin}),Object.defineProperty(this,u,{writable:!0,value:"/api/authenticate/"}),Object.defineProperty(this,h,{writable:!0,value:"/api/user-info/"}),Object.defineProperty(this,p,{writable:!0,value:"production"}),Object.defineProperty(this,d,{writable:!0,value:"https://sso.tga.gov.tr"}),Object.defineProperty(this,g,{writable:!0,value:"https://preflight.tga.gov.tr"}),Object.defineProperty(this,y,{writable:!0,value:"/"}),Object.defineProperty(this,f,{writable:!0,value:"token"}),Object.defineProperty(this,w,{writable:!0,value:"Bearer"}),Object.defineProperty(this,S,{writable:!0,value:""}),s(this,l)[l]=t||""}get appURL(){return s(this,c)[c]}get apiURL(){return s(this,l)[l]}get authenticateEndpoint(){return s(this,u)[u]}get userInfoEndpoint(){return s(this,h)[h]}get preflightURL(){return s(this,g)[g]}get ssoURL(){return s(this,d)[d]}get mode(){return s(this,p)[p]}get localStorageKey(){return s(this,f)[f]}get bearerTokenKey(){return s(this,w)[w]}get originSourceQuery(){return s(this,S)[S]}get redirectPath(){return s(this,y)[y]}setupOriginSource(t){s(this,S)[S]=null==t?void 0:t.replaceAll("https://","").replaceAll("http://","")}setupSSOModeAndURL(t){s(this,p)[p]=t,s(this,d)[d]="development"===t?"https://tga-sso-frontend-dev.arge-tga.com":"https://sso.tga.gov.tr"}redirectSSO(t,e,r=!1){if(r)return;t&&console.error(t),localStorage.removeItem(s(this,f)[f]);const{host:i,hostname:n}=window.location;window.open(`${b.ssoURL}/login?url=${i}${"localhost"===n?`&origin=${b.originSourceQuery}`:""}`,"_self"),e&&e()}configure(t){s(this,l)[l]=t.apiURL||s(this,l)[l],s(this,c)[c]=t.appURL||s(this,c)[c],s(this,u)[u]=t.authenticateEndpoint||s(this,u)[u],s(this,h)[h]=t.userInfoEndpoint||s(this,h)[h],s(this,g)[g]=t.preflightURL||s(this,g)[g],s(this,y)[y]=t.redirectPath||s(this,y)[y],s(this,f)[f]=t.localStorageKey||s(this,f)[f],s(this,w)[w]=t.bearerTokenKey||s(this,w)[w],this.setupOriginSource(t.originSourceQuery||s(this,S)[S]),this.setupSSOModeAndURL(t.mode||s(this,p)[p])}};async function v(t,e){const{timeout:r=25e3}=e,i=new AbortController,o=setTimeout(()=>i.abort(),r),a=await fetch(t,n({},e,{signal:i.signal,headers:n({"Content-Type":"application/json"},e.headers)}));return clearTimeout(o),a}const O=(n=!0,o)=>{const[a,s]=t(!1),[l,c]=t(!1),[u,h]=t(null),p=e(),d=e(b.redirectPath),g=r(async(t,e)=>{var r;const i=await v(`${b.apiURL}${b.authenticateEndpoint}`,{signal:e,method:"POST",body:JSON.stringify({token:t})}),n=await i.json();return null!=n&&n.success?(localStorage.setItem(b.localStorageKey,JSON.stringify(null==n||null==(r=n.data)?void 0:r.token)),s(!0),null==n?void 0:n.data):b.redirectSSO("autheticate !data?.success on :35")},[]),y=r(async t=>{const e=await v(`${b.apiURL}${b.userInfoEndpoint}`,{signal:t,method:"GET",headers:{Authorization:`${b.bearerTokenKey} ${JSON.parse(localStorage.getItem(b.localStorageKey))}`}}),r=await e.json();return null!=r&&r.success?(d.current=window.location.pathname,s(!0),null==r?void 0:r.data):b.redirectSSO("userInfo !data.success on :59")},[]),f=r(async()=>{c(!0);const t=JSON.parse(localStorage.getItem(b.localStorageKey)),e=new URLSearchParams(window.location.search).get("token");if(!t&&!e)return b.redirectSSO("handleAuth !token && !ssoToken on :71 ");try{p.current=new AbortController;const r=t?await y(p.current.signal):await g(e,p.current.signal);h(r),o&&o(r)}catch(t){return localStorage.removeItem(b.localStorageKey),b.redirectSSO("handleAuth catch error on :82")}finally{c(!1),window.history.pushState({},document.title,d.current)}},[]);return i(()=>{if(n)return f(),()=>{var t;"production"===b.mode&&(null==(t=p.current)||t.abort())}},[n]),{isAuthed:a,isAuthing:l,user:u}},m=()=>{const[r,n]=t(!1),[o,a]=t(!0),s=e();return i(()=>((async()=>{try{s.current=new AbortController;const t=await v(b.preflightURL,{signal:s.current.signal,method:"GET",timeout:25e3}),e=await t.json();t.ok&&e.success&&n(!0)}catch(t){n(!1)}finally{a(!1)}})(),()=>{var t;"production"===b.mode&&(null==(t=s.current)||t.abort())}),[]),{isPreflighting:o,isAllowed:r}};export{b as SSO,O as useAuth,m as usePreflight};
