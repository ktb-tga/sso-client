import{useState as t,useRef as e,useCallback as r,useEffect as i}from"react";function o(){return o=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(t[i]=r[i])}return t},o.apply(this,arguments)}var n=0;function a(t){return"__private_"+n+++"_"+t}function s(t,e){if(!Object.prototype.hasOwnProperty.call(t,e))throw new TypeError("attempted to use private field on non-instance");return t}var l=/*#__PURE__*/a("appURL"),c=/*#__PURE__*/a("apiURL"),u=/*#__PURE__*/a("authenticateEndpoint"),h=/*#__PURE__*/a("userInfoEndpoint"),p=/*#__PURE__*/a("mode"),d=/*#__PURE__*/a("ssoURL"),g=/*#__PURE__*/a("preflightURL"),f=/*#__PURE__*/a("redirectPath"),y=/*#__PURE__*/a("localStorageKey"),w=/*#__PURE__*/a("originSourceQuery");const b=new class{constructor(){Object.defineProperty(this,l,{writable:!0,value:void 0}),Object.defineProperty(this,c,{writable:!0,value:void 0}),Object.defineProperty(this,u,{writable:!0,value:"/api/authenticate/"}),Object.defineProperty(this,h,{writable:!0,value:"/api/user-info/"}),Object.defineProperty(this,p,{writable:!0,value:"production"}),Object.defineProperty(this,d,{writable:!0,value:"https://sso.tga.gov.tr"}),Object.defineProperty(this,g,{writable:!0,value:"https://preflight.tga.gov.tr/api/preflight/"}),Object.defineProperty(this,f,{writable:!0,value:"/"}),Object.defineProperty(this,y,{writable:!0,value:"token"}),Object.defineProperty(this,w,{writable:!0,value:""})}get appURL(){return s(this,l)[l]}get apiURL(){return s(this,c)[c]}get authenticateEndpoint(){return s(this,u)[u]}get userInfoEndpoint(){return s(this,h)[h]}get preflightURL(){return s(this,g)[g]}get ssoURL(){return s(this,d)[d]}get mode(){return s(this,p)[p]}get localStorageKey(){return s(this,y)[y]}get originSourceQuery(){return s(this,w)[w]}get redirectPath(){return s(this,f)[f]}set redirectPath(t){s(this,f)[f]=t}setupOriginSource(t){s(this,w)[w]=null==t?void 0:t.replaceAll("https://","").replaceAll("http://","")}setupSSOModeAndURL(t){s(this,p)[p]=t,s(this,d)[d]="development"===t?"https://tga-sso-frontend-dev.arge-tga.com":"https://sso.tga.gov.tr"}configure(t){s(this,l)[l]=t.appURL||s(this,l)[l],s(this,c)[c]=t.apiURL||s(this,c)[c],s(this,u)[u]=t.authenticateEndpoint||s(this,u)[u],s(this,h)[h]=t.userInfoEndpoint||s(this,h)[h],s(this,g)[g]=t.preflightURL||s(this,g)[g],s(this,f)[f]=t.redirectPath||s(this,f)[f],s(this,y)[y]=t.localStorageKey||s(this,y)[y],this.setupOriginSource(t.originSourceQuery||s(this,w)[w]),this.setupSSOModeAndURL(t.mode||s(this,p)[p])}};async function v(t,e){const{timeout:r=25e3}=e,i=new AbortController,n=setTimeout(()=>i.abort(),r),a=await fetch(t,o({},e,{signal:i.signal,headers:o({"Content-Type":"application/json"},e.headers)}));return clearTimeout(n),a}const S=(o=!0)=>{const[n,a]=t(!1),[s,l]=t(!1),[c,u]=t(null),h=e(()=>{}),p=e(b.redirectPath),d=r(async(t,e)=>{var r;const i=await v(`${b.apiURL}${b.authenticateEndpoint}`,{signal:e,method:"POST",body:JSON.stringify({token:t})}),o=await i.json();return null!=o&&o.success?(localStorage.setItem(b.localStorageKey,JSON.stringify(null==o||null==(r=o.data)?void 0:r.token)),a(!0),null==o?void 0:o.data):m()},[]),g=r(async t=>{const e=await v(`${b.apiURL}${b.userInfoEndpoint}`,{signal:t,method:"GET",headers:{Authorization:`Token ${JSON.parse(localStorage.getItem(b.localStorageKey))}`}}),r=await e.json();return r.success?(a(!0),p.current=window.location.pathname,null==r?void 0:r.data):m()},[]),f=r(async()=>{l(!0);const t=JSON.parse(localStorage.getItem(b.localStorageKey)),e=new URLSearchParams(window.location.search).get("token");if(!t&&!e)return m();try{const r=new AbortController,i=r.signal;h.current=r.abort;const o=t?await g(i):await d(e,i);u(o)}catch(t){return localStorage.removeItem(b.localStorageKey),m()}finally{l(!1),window.history.pushState({},document.title,p.current)}},[]);return i(()=>{if(o)return f(),()=>{"production"===b.mode&&h.current()}},[o]),{isAuthed:n,isAuthing:s,user:c}};function m(){const{host:t,hostname:e}=window.location;window.open(`${b.ssoURL}/login?url=${t}${"localhost"===e?`&origin=${b.originSourceQuery}`:""}`,"_self")}const O=()=>{const[r,o]=t(!1),[n,a]=t(!0),s=e(()=>{});return i(()=>((async()=>{try{const t=new AbortController,e=t.signal;s.current=t.abort;const r=await v(b.preflightURL,{signal:e,method:"GET",timeout:25e3}),i=await r.json();r.ok&&i.success&&o(!0)}catch(t){o(!1)}finally{a(!1)}})(),()=>{"production"===b.mode&&s.current()}),[]),{isPreflighting:n,isAllowed:r}};export{b as SSO,S as useAuth,O as usePreflight};
