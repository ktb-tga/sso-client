import{useState as t,useRef as e,useCallback as r,useEffect as i}from"react";function o(){return o=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(t[i]=r[i])}return t},o.apply(this,arguments)}var n=0;function a(t){return"__private_"+n+++"_"+t}function s(t,e){if(!Object.prototype.hasOwnProperty.call(t,e))throw new TypeError("attempted to use private field on non-instance");return t}var l=/*#__PURE__*/a("apiURL"),c=/*#__PURE__*/a("appURL"),u=/*#__PURE__*/a("authenticateEndpoint"),h=/*#__PURE__*/a("userInfoEndpoint"),d=/*#__PURE__*/a("mode"),p=/*#__PURE__*/a("ssoURL"),g=/*#__PURE__*/a("preflightURL"),y=/*#__PURE__*/a("redirectPath"),f=/*#__PURE__*/a("localStorageKey"),w=/*#__PURE__*/a("bearerTokenKey"),S=/*#__PURE__*/a("originSourceQuery");const b=new class{constructor({apiURL:t}={}){Object.defineProperty(this,l,{writable:!0,value:void 0}),Object.defineProperty(this,c,{writable:!0,value:window.location.origin}),Object.defineProperty(this,u,{writable:!0,value:"/api/authenticate/"}),Object.defineProperty(this,h,{writable:!0,value:"/api/user-info/"}),Object.defineProperty(this,d,{writable:!0,value:"production"}),Object.defineProperty(this,p,{writable:!0,value:"https://sso.tga.gov.tr"}),Object.defineProperty(this,g,{writable:!0,value:"https://preflight.tga.gov.tr"}),Object.defineProperty(this,y,{writable:!0,value:"/"}),Object.defineProperty(this,f,{writable:!0,value:"token"}),Object.defineProperty(this,w,{writable:!0,value:"Bearer"}),Object.defineProperty(this,S,{writable:!0,value:""}),s(this,l)[l]=t||""}get appURL(){return s(this,c)[c]}get apiURL(){return s(this,l)[l]}get authenticateEndpoint(){return s(this,u)[u]}get userInfoEndpoint(){return s(this,h)[h]}get preflightURL(){return s(this,g)[g]}get ssoURL(){return s(this,p)[p]}get mode(){return s(this,d)[d]}get localStorageKey(){return s(this,f)[f]}get bearerTokenKey(){return s(this,w)[w]}get originSourceQuery(){return s(this,S)[S]}get redirectPath(){return s(this,y)[y]}setupOriginSource(t){s(this,S)[S]=null==t?void 0:t.replaceAll("https://","").replaceAll("http://","")}setupSSOModeAndURL(t){s(this,d)[d]=t,s(this,p)[p]="development"===t?"https://tga-sso-frontend-dev.arge-tga.com":"https://sso.tga.gov.tr"}redirectSSO(t,e,r=!1){if(r)return;t&&console.error(t),localStorage.removeItem(s(this,f)[f]);const{host:i,hostname:o}=window.location;window.open(`${b.ssoURL}/login?url=${i}${"localhost"===o?`&origin=${b.originSourceQuery}`:""}`,"_self"),e&&e()}configure(t){s(this,l)[l]=t.apiURL||s(this,l)[l],s(this,c)[c]=t.appURL||s(this,c)[c],s(this,u)[u]=t.authenticateEndpoint||s(this,u)[u],s(this,h)[h]=t.userInfoEndpoint||s(this,h)[h],s(this,g)[g]=t.preflightURL||s(this,g)[g],s(this,y)[y]=t.redirectPath||s(this,y)[y],s(this,f)[f]=t.localStorageKey||s(this,f)[f],s(this,w)[w]=t.bearerTokenKey||s(this,w)[w],this.setupOriginSource(t.originSourceQuery||s(this,S)[S]),this.setupSSOModeAndURL(t.mode||s(this,d)[d])}};async function v(t,e){const{timeout:r=25e3}=e,i=new AbortController,n=setTimeout(()=>i.abort(),r),a=await fetch(t,o({},e,{mode:"cors",signal:i.signal}));return clearTimeout(n),a}const O=(o=!0,n,a=!1)=>{const[s,l]=t(!1),[c,u]=t(!1),[h,d]=t(null),p=e(),g=e(b.redirectPath),y=r(async(t,e)=>{var r;const i=await v(`${b.apiURL}${b.authenticateEndpoint}`,{signal:e,method:"POST",body:JSON.stringify({token:t})}),o=await i.json();return null!=o&&o.success?(localStorage.setItem(b.localStorageKey,JSON.stringify(null==o||null==(r=o.data)?void 0:r.token)),l(!0),null==o?void 0:o.data):b.redirectSSO("autheticate !data?.success on :35",void 0,a)},[]),f=r(async t=>{const e=await v(`${b.apiURL}${b.userInfoEndpoint}`,{signal:t,method:"GET",headers:{Authorization:`${b.bearerTokenKey} ${JSON.parse(localStorage.getItem(b.localStorageKey))}`}}),r=await e.json();return null!=r&&r.success?(g.current=window.location.pathname,l(!0),null==r?void 0:r.data):b.redirectSSO("userInfo !data.success on :59",void 0,a)},[]),w=r(async()=>{u(!0);const t=JSON.parse(localStorage.getItem(b.localStorageKey)),e=new URLSearchParams(window.location.search).get("token");if(!t&&!e)return b.redirectSSO("handleAuth !token && !ssoToken on :71",void 0,a);try{p.current=new AbortController;const r=t?await f(p.current.signal):await y(e,p.current.signal);d(r),n&&n(r)}catch(t){return localStorage.removeItem(b.localStorageKey),b.redirectSSO("handleAuth catch error on :82",void 0,a)}finally{u(!1),window.history.pushState({},document.title,g.current)}},[]);return i(()=>{if(o)return w(),()=>{var t;"production"===b.mode&&(null==(t=p.current)||t.abort())}},[o]),{isAuthed:s,isAuthing:c,user:h}},m=()=>{const[r,o]=t(!1),[n,a]=t(!0),s=e();return i(()=>((async()=>{try{s.current=new AbortController;const t=await v(b.preflightURL,{signal:s.current.signal,method:"GET",timeout:25e3}),e=await t.json();t.ok&&e.success&&o(!0)}catch(t){o(!1)}finally{a(!1)}})(),()=>{var t;"production"===b.mode&&(null==(t=s.current)||t.abort())}),[]),{isPreflighting:n,isAllowed:r}};export{b as SSO,O as useAuth,m as usePreflight};
